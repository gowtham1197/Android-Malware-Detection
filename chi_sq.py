import csv

def load_csv(filename):
	lines=csv.reader(open(filename,"rb"))
	dataset=list(lines)
	for i in range(1,len(dataset)):
		for j in range(0,len(dataset[1])):
		    dataset[i][j]=float(dataset[i][j])
	return dataset

def load_csv2(filename):
	lines=csv.reader(open(filename,"rb"))
	dataset=list(lines)
	for i in range(1,len(dataset)):
		for j in range(0,len(dataset[1])-1):
		    dataset[i][j]=float(dataset[i][j])
	return dataset

dataset_m=load_csv('processed_m.csv')
features_m=dataset_m[0]
dataset_b=load_csv('processed_b.csv')
features_b=dataset_b[0]
del dataset_b[0]
del dataset_m[0]

#print dataset_m
#print dataset_b

tot_features=[]
tot_features.append(features_b)
tot_features.append(features_m)
tot_features=sum(tot_features,[])
tot_features=list(set(tot_features))
#print tot_features
#print len(tot_features)
#print len(features_m)
#for i in range(len(tot_features)):
#	if(tot_features[i]=='clock_gettime'):
del tot_features[0]

with open('chi_sq.csv', 'w') as csvfile:
		csvwriter = csv.writer(csvfile)
		csvwriter.writerow(tot_features)

tot_features_freq_m=[]
for i in range(len(tot_features)):
	flag=0
	for j in range(len(features_m)):
		if(tot_features[i]==features_m[j]):
			flag=1
			col=[row[j] for row in dataset_m]
			tot_features_freq_m.append(sum(col))
		else:
		#tot_features_freq_m.append(0)
		    continue
	if(flag==0):
		tot_features_freq_m.append(0)

#print tot_features_freq_m
#print len(tot_features_freq_m)
tot_features_freq_m_neg=[]
for i in range(len(tot_features_freq_m)):
	tot_features_freq_m_neg.append(50-tot_features_freq_m[i])

#print tot_features_freq_m_neg
#print len(tot_features_freq_m_neg)

with open('chi_sq.csv', 'a') as csvfile:
		csvwriter = csv.writer(csvfile)
		tot_features_freq_m.append('freqm')
		tot_features_freq_m_neg.append('freqnm')
		csvwriter.writerow(tot_features_freq_m)
		csvwriter.writerow(tot_features_freq_m_neg)


tot_features_freq_b=[]
for i in range(len(tot_features)):
	flag=0
	for j in range(len(features_b)):
		if(tot_features[i]==features_b[j]):
			flag=1
			col=[row[j] for row in dataset_b]
			tot_features_freq_b.append(sum(col))
		else:
		#tot_features_freq_m.append(0)
		    continue
	if(flag==0):
		tot_features_freq_b.append(0)

#print tot_features_freq_m
#print len(tot_features_freq_m)
tot_features_freq_b_neg=[]
for i in range(len(tot_features_freq_b)):
	tot_features_freq_b_neg.append(50-tot_features_freq_b[i])

with open('chi_sq.csv', 'a') as csvfile:
		csvwriter = csv.writer(csvfile)
		tot_features_freq_b.append('freqb')
		tot_features_freq_b_neg.append('freqnb')
		csvwriter.writerow(tot_features_freq_b)
		csvwriter.writerow(tot_features_freq_b_neg)


dataset_chisq=load_csv2('chi_sq.csv')
#del dataset_chisq[0]
rank=[]
#print dataset_chisq
for i in range(len(dataset_chisq[1])-1):
	C=dataset_chisq[1][i]
	D=dataset_chisq[2][i]
	A=dataset_chisq[3][i]
	B=dataset_chisq[4][i]
	part=(A*D)-(C*B)
	value=100*(pow(part,2))/((A+C)*(B+D)*(A+B)*(C+D))
	rank.append(value)

#print rank
with open('chi_sq.csv', 'a') as csvfile:
		csvwriter = csv.writer(csvfile)
		csvwriter.writerow(rank)


#print dataset_chisq[0]

to_sort=[]
to_sort.append(rank)
to_sort.append(dataset_chisq[0])
#print to_sort


#print len(to_sort[0])
#print len(to_sort[1])

for i in range(len(to_sort[0])-1):
	for j in range(len(to_sort[0])-1):
		if(to_sort[0][j]>to_sort[0][j+1]):
				t=to_sort[0][j]
				to_sort[0][j]=to_sort[0][j+1]
				to_sort[0][j+1]=t
				m=to_sort[1][j]
				to_sort[1][j]=to_sort[1][j+1]
				to_sort[1][j+1]=m
		else:
			continue
#print to_sort

frequencies=to_sort[0]
imp_frequencies=frequencies[-12:]
#print imp_frequencies
features=to_sort[1]
imp_features=features[-12:]
#print imp_features

print "After Feature Extraction using chisquare, we get the following top 12 features:"
print "\n"
#print "Features\t\tFrequencies"
for i in range(len(imp_features)):
	print "Feature : %s\n Frequnecy :%f" %(imp_features[i], imp_frequencies[i])


with open('final_dataset.csv', 'w') as csvfile:
		csvwriter = csv.writer(csvfile)
		csvwriter.writerow(imp_features)

